---
layout: single
title: "무중단 배포에 대하여"
date: 2022-08-22 00:05
tags: 
  - Deployment
---

# 2021-08-22_Zero_Downtime_Deployment

# 무중단 배포에 대하여

개발자로 일하다 보면 가끔

‘아 이건 그래도 적용했어야 했는데…’

혹은

‘이건 이런 식으로 바꾸면 더 좋을 것 같은데…’

하고 생각하면서도 미처 바꾸거나 끝내지 못하는 일들이 있다.

물론 ‘일하다’ 있는 일들이다 보니, 기능 구현이 바빠서, DB 값이 꼬여서, 버그가 터져서 등등 여러 이유와 선행작업에 밀려 완수하지 못한 경우가 대부분인데 내 경우엔 로드밸런서를 활용한 다중 서버 활용과 무중단 배포가 그렇다.

얼마전까지 소속되었던 팀에선 크게 2가지 프로젝트를 개발/운영했는데, 이 두 프로젝트 모두 이용량이 그렇게 많지 않아 딱히 여러 개의 서버를 구축할 필요가 없기는 했지만, 그럼에도 단일 서버의 한계로 인해 배포 시 다운 타임이 생기는 부분은 항상 아쉬웠다.

특히, 프로덕트 특성상 9-6시 사이에 이용량이 집중된 형태라, 근무시간 내에 배포할 수 없는 부분이 가장 불편했다. 딱히 추가 근무할 업무가 없음에도, 배포를 위해 추가 근무하는 셈이라 더욱 그러했다.

때문에 재직하는 동안 항상 서버 갯수를 늘려서 무중단 배포 형식으로 운영하고 싶었는데, 이제 남는게 시간이니 공부하고 싶었던 것들을 하나하나씩 정리해보려고 한다.

## 배포란 무엇인가?

개발 결과물을 서버에 적용하는 행위를 말한다. 앞으로는 어떻게 변할지 모르나, 내 경우엔 열심히 만들어 놓은 웹 어플리케이션 War파일로 압축하여, 클라우드 서버의 톰캣 webapp 폴더에 넣고 톰캣을 재시작하는 행위였다. (재직중에 다루었던 거의 대부분의 프로덕트들이 이런식으로 FE와 BE가 하나의 프로젝트에 합쳐진 웹 어플리케이션 형태였다.)

이 경우 단일 서버에 배포하는 데에 그쳤기 때문에 편리했지만, 항상 다운타임이 발생하였다. 또한 배포 이후 수정된 부분이나 예상치 못한 부분에서 오류가 발생할 수 있는데 배포한 프로덕트가 곧바로 이용자들에게 제공되는 형식이다보니 치명적인 오류가 그대로 고객에게 전달될 수 있는 문제점도 내포하고 있었다.

## 그래서 무중단 배포는?

무중단 배포는 어플리케이션을 제공하는 서버를 여러 개로 분산하고, 해당 서버들에 대한 트래픽(요청)을 클라우드 로드밸런서로 관리하여,

- 이 때, 클라우드 로드 밸런서란,

    > *로드밸런서는 고객의 서비스에 대한 네트워크 트래픽을 분산해 서버의 부하를 경감합니다. 로드밸런서에 연결된 서버 중 일부 서버에 장애가 발생하면 자동으로 다른 정상 서버로 부하를 배분해 무정지 서비스가 가능하게 해 서비스의 높은 안정성을 보장합니다.*

    [NAVER CLOUD PLATFORM](https://www.ncloud.com/product/networking/loadBalancer)

1. 로드밸런서에 포함된 서버 하나를 로드밸런서에서 제외한 후, 신규 버전을 배포한다.
2. a에서 배포한 버전을 테스트한다.
3. 테스트에서 문제점이 없다면 로드밸런서에 추가하고, 기존에 유저들에게 제공하던 서버를 로드밸런서에서 제외한다.
4. 제외된 나머지 서버에 신규 버전을 배포한다.

위의 과정을 기본 골자로 사용자가 배포로 인한 다운타임을 체감하지 못하고, 지속적인 성능/기능 개선과 서비스 고가용성을 확보하는 형식의 서버 운영 전략이라고 볼 수 있다.

위의 전략의 명칭은 **롤링 배포(Rolling Deployment)**로 언뜻 보기엔 괜찮아 보이지만, C 과정을 진행하는 중에 호환성 문제가 발생할 수 있다.

위 전략에선 다운타임을 발생시키지 않기 위해선 두 가지 버전의 서버가 모두 로드밸런서에 들어가 있는 순간이 필연적인데, 이 경우 로드밸런서에 의해 A유저는 기존 버전의 어플리케이션을, B유저는 신규 버전의 어플리케이션을 제공받을 수 있다는 사실을 의미한다.

![/assets/images/posts/2021-08-22/Untitled.png](/assets/images/posts/2021-08-22/Untitled.png)

Untitled

롤링배포는 결국 구버전과 신버전이 공존하는 상황이 발생한다.

## 블루-그린 배포(Blue-Green Deployment)

이러한 롤링 배포 전략의 문제점 때문에 대안으로 나온 전략이 바로 블루-그린 배포(Blue-Green Deployment)이다.

이 전략은 비용 효율성 부분을 다소 포기하고 가용성을 얻어낸 전략이라고 생각하는데, 배포를 위해 기존의 로드밸런서에 포함된 서버들 (이하 인스턴스)과 동일한 사양, 갯수, 환경의 복사본을 생성하고 해당 인스턴스들에 새로운 버전의 어플리케이션을 배포한다. 이를 그린 인스턴스라고 한다.

이후 테스트나 검증 과정이 지나 해당 버전이 적합하다고 판단하면, 로드밸런서의 모든 트래픽들 한번에 그린 인스턴스로 전환하고 블루 인스턴스의 연결을 해제한다.

![/assets/images/posts/2021-08-22/화면_캡처_2021-08-21_232143.jpg](/assets/images/posts/2021-08-22/화면_캡처_2021-08-21_232143.jpg)

화면 캡처 2021-08-21 232143.jpg

롤링 배포 전략과 마찬가지로 롤백이 쉽고, 가용 인스턴스가 최소 2배임을 가정하기에 테스트 환경을 구축하기에도 적합하다. 신규 배포를 통해 이용자에게 서비스를 제공하는 그린 인스턴스는 추후 배포시 블루 인스턴스로 재활용된다.

다만, 앞서 말했듯 가용 인스턴스가 2배이므로 비용적인 부분에서 손해를 보는 점은 큰 단점이 될 수 있다.

## 카나리 배포

롤링 배포와 블루-그린 배포 방식을 조금씩 혼합한듯한 배포 전략이다. (~~순전히 작성사의 주관적 인식입니다.)~~

롤링 배포와 유사한 방식으로 로드 밸런서에 올라간 인스턴스 중 일부에 신규 버전을 배포하고 운영하여, 차례대로 인스턴스들의 버전을 갱신하는 방식인데, 롤링 배포와 가장 큰 차이점은

1. 신규 버전을 배포하는 인스턴스를 굳이 로드 밸런서에서 제외하지 않는 것
2. 로드 밸런서 설정을 통해 신규 버전에 할당되는 이용자의 비율을 조절하거나, 특정하는 것이다.

![/assets/images/posts/2021-08-22/Untitled%201.png](/assets/images/posts/2021-08-22/Untitled%201.png)

Untitled

롤링 배포에선 하나의 로드 밸런서에 포함된 서로 다른 버전의 인스턴스가 호환성 문제를 야기할 수 있는 요인으로 보았다면, 카나리 배포에선 이러한 특성을 적극적으로 활용하여, 신규 버전 배포 이전의 테스트를 위한 장치로 사용한다는 점이 주된 전략이라고 볼 수 있다.

블루-그린 배포 전략처럼 이용자에게 제공하기 이전 테스트를 수행하기 용이하고, 신규 버전이 배포된 카나리 인스턴스에 할당되는 트래픽 비율을 조정하여 운영되는 서버 자원에 과부하가 가지 않도록 조절하는 것또한 가능하다.

다만 롤링 배포와 동일하게 **의도치 않은** 호환성 문제가 야기될 수 있으므로 주의를 기울여야 한다. (‘의도치 않은’ 문제는 언제나 본인과 동료들을 힘들게 하니까… 사무실에서 들리는 “아..” 소리가 제일 무섭다.)

위 방식들이 대표적으로 알려진 무중단 배포 방식이며, 몇 가지 방법이 더 있다고 보는데 직접 클라우드 서비스에서 활용해보는게 학습에 적합할 듯 싶으니 이번 포스팅은 여기서 마무리!

